<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Hepa Simulation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        h1 { color: #333; margin-bottom: 20px; font-size: 1.5rem; }

        #chat-container {
            width: 100%;
            max-width: 600px;
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.4;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Nurse Styling (Left) */
        .message.NURSE {
            align-self: flex-start;
            background-color: #e3f2fd;
            color: #0d47a1;
            border-bottom-left-radius: 4px;
        }

        /* Patient Styling (Right) */
        .message.PATIENT {
            align-self: flex-end;
            background-color: #e8f5e9;
            color: #1b5e20;
            border-bottom-right-radius: 4px;
        }

        .speaker-name {
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 4px;
            display: block;
            opacity: 0.7;
        }

        .system-msg {
            align-self: center;
            background: #eee;
            color: #666;
            font-size: 0.8rem;
            padding: 5px 12px;
            border-radius: 20px;
            font-style: italic;
        }

        .controls {
            display: flex;
            gap: 15px;
        }

        button {
            padding: 12px 24px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        #startBtn { background-color: #2196f3; color: white; }
        #startBtn:hover { background-color: #1976d2; }
        #startBtn:disabled { background-color: #b0bec5; cursor: not-allowed; }

        #stopBtn { background-color: #f44336; color: white; }
        #stopBtn:hover { background-color: #d32f2f; }
        #stopBtn:disabled { background-color: #ffcdd2; cursor: not-allowed; }

        .status { margin-top: 10px; font-size: 0.9rem; color: #666; }
        .status.connected { color: #2e7d32; }
        .status.disconnected { color: #c62828; }
    </style>
</head>
<body>

    <h1>üè• Clinic Hepa: Nurse-Patient Sim</h1>

    <div id="chat-container">
        <!-- Messages will appear here -->
    </div>

    <div class="controls">
        <button id="startBtn" onclick="startSimulation()">Start Simulation</button>
        <button id="stopBtn" onclick="stopSimulation()" disabled>Stop</button>
    </div>
    <div id="status" class="status">Ready</div>

    <script>
        // --- CONFIGURATION ---
        // We use wss:// because the backend is https://
        const BACKEND_URL = "wss://clinic-hepa-backend-481780815788.us-central1.run.app/ws/simulation";
        
        // --- STATE ---
        let socket = null;
        let audioContext = null;
        let nextStartTime = 0; // Ensures gapless playback
        const chatContainer = document.getElementById('chat-container');
        const statusDiv = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');

        async function startSimulation() {
            // 1. Initialize Audio Context (Must happen after user click)
            try {
                if (!audioContext) {
                    // Gemini outputs 24kHz audio
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
                } else if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
            } catch (e) {
                console.error("Audio Context Error:", e);
                alert("Could not initialize audio. Please use Chrome or Edge.");
                return;
            }

            // 2. Connect WebSocket
            updateStatus("Connecting...", "");
            socket = new WebSocket(BACKEND_URL);

            socket.onopen = () => {
                updateStatus("Connected", "connected");
                startBtn.disabled = true;
                stopBtn.disabled = false;
                
                // Send the trigger command defined in server.py
                socket.send("start");
                addSystemMessage("Initializing Agents...");
            };

            socket.onmessage = async (event) => {
                const msg = JSON.parse(event.data);

                if (msg.type === "transcript") {
                    addMessage(msg.speaker, msg.text);
                } 
                else if (msg.type === "audio") {
                    playPcmAudio(msg.data);
                }
                else if (msg.type === "system") {
                    addSystemMessage(msg.message);
                }
            };

            socket.onclose = (event) => {
                updateStatus("Disconnected", "disconnected");
                startBtn.disabled = false;
                stopBtn.disabled = true;
                addSystemMessage("Connection closed.");
                console.log("WebSocket Closed:", event);
            };

            socket.onerror = (error) => {
                console.error("WebSocket Error:", error);
                updateStatus("Connection Error", "disconnected");
            };
        }

        function stopSimulation() {
            if (socket) {
                socket.close();
            }
            if (audioContext) {
                audioContext.suspend();
            }
        }

        // --- UI HELPERS ---
        function updateStatus(text, className) {
            statusDiv.innerText = text;
            statusDiv.className = `status ${className}`;
        }

        function addMessage(speaker, text) {
            const div = document.createElement('div');
            div.className = `message ${speaker}`;
            div.innerHTML = `<span class="speaker-name">${speaker}</span>${text}`;
            chatContainer.appendChild(div);
            // Auto-scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'system-msg';
            div.innerText = text;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // --- AUDIO ENGINE ---
        // Decodes Base64 -> Raw PCM 16-bit -> Float32 -> Web Audio API
        function playPcmAudio(base64Data) {
            if (!audioContext) return;

            const binaryString = atob(base64Data);
            const len = binaryString.length;
            
            // Convert binary string to Int16Array (PCM 16-bit Little Endian)
            const int16Data = new Int16Array(len / 2);
            for (let i = 0; i < len; i += 2) {
                const low = binaryString.charCodeAt(i);
                const high = binaryString.charCodeAt(i + 1);
                // Combine two bytes into one 16-bit integer
                int16Data[i / 2] = (high << 8) | low;
            }

            // Convert Int16 to Float32 (-1.0 to 1.0)
            const float32Data = new Float32Array(int16Data.length);
            for (let i = 0; i < int16Data.length; i++) {
                float32Data[i] = int16Data[i] / 32768.0; 
            }

            // Create AudioBuffer (Mono, Length, 24kHz Sample Rate)
            const buffer = audioContext.createBuffer(1, float32Data.length, 24000);
            buffer.getChannelData(0).set(float32Data);

            // Create Source Node
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);

            // Schedule Playback (Gapless)
            const currentTime = audioContext.currentTime;
            if (nextStartTime < currentTime) {
                nextStartTime = currentTime;
            }
            source.start(nextStartTime);
            nextStartTime += buffer.duration;
        }
    </script>
</body>
</html>